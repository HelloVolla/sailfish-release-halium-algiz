name: Github CI build

# GITHUB_REF_NAME in the form of release-$VERSION-$RELEASE-$EXTRA_NAME

on:
  push:
    tags:
      - release-**-**-**
  workflow_dispatch:

env:
  RELEASESDK: 4.5.0.16

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - uses: actions/checkout@v3
        
    - name: Build mic
      run:  |
        export VERSION=devel
        export RELEASE=4.5.0.24
        export EXTRA_NAME=-alpha2
        docker run --rm --privileged -v $PWD:/share --env-file env.list -e VERSION -e RELEASE -e EXTRA_NAME coderus/sailfishos-platform-sdk:$RELEASESDK /bin/bash -c " 
            find \
            ./scripts/create-image.sh --release $RELEASE --version $VERSION"

    - name: Update release
      run: |
        gh release upload ${{ github.ref_name }} output/mic/sfe-*/*.zip --clobber 
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
